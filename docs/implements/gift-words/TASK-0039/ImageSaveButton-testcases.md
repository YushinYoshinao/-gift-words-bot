# TASK-0039: ImageSaveButton テストケース定義書

## 📋 基本情報

- **タスクID**: TASK-0039
- **機能名**: ImageSaveButton (画像保存ボタンコンポーネント)
- **テストファイル**: `src/components/DisplayPage/__tests__/ImageSaveButton.test.tsx`
- **作成日**: 2025-11-22

## 開発言語・フレームワーク

### 🔵 プログラミング言語
- **言語**: TypeScript 5.0+
- **言語選択の理由**:
  - プロジェクト全体でTypeScriptを採用
  - 型安全性によりコンポーネントのProps型を厳密に検証可能
  - React + TypeScriptの組み合わせは業界標準
- **テストに適した機能**:
  - インターフェース定義による明確な契約
  - コンパイル時の型チェックでバグ早期発見
  - IDEの自動補完によるテスト記述効率向上

### 🔵 テストフレームワーク
- **フレームワーク**: Vitest + React Testing Library
- **フレームワーク選択の理由**:
  - Viteプロジェクトとの統合が容易
  - Jest互換のAPIで学習コストが低い
  - 高速なテスト実行
  - React Testing Libraryはユーザー視点のテストに適している
- **テスト実行環境**:
  - Node.js 18+
  - jsdom環境（ブラウザDOM APIエミュレーション）
  - モック: vi.mock() による依存関係のモック化

### 🔵 モック戦略
- **useImageExport**: TASK-0038で実装済みのフックをモック化
  - exportAsImage関数のモック
  - isExportingstate のモック（初期false、実行中true）
- **document.querySelector**: DOM要素取得のモック
- **console.error**: エラーログ出力の検証用にモック

## テストケース一覧

### 1. 正常系テストケース（基本的な動作）

#### テストケース 1-1: 正しくレンダリングされる

- **テスト名**: 正しくレンダリングされる
  - **何をテストするか**: コンポーネントが正常にマウントされ、初期状態で正しく表示される
  - **期待される動作**: ボタンが画面に表示され、初期テキストが「画像として保存」になる
- **入力値**:
  ```typescript
  <ImageSaveButton
    targetSelector=".test-container"
    filename="test-image"
  />
  ```
  - **入力データの意味**: 基本的なProps設定でコンポーネントをレンダリング
- **期待される結果**:
  - ボタンが存在する (`screen.getByRole('button')`)
  - ボタンテキストが「画像として保存」
  - ローディング表示は存在しない
  - **期待結果の理由**: 初期状態ではエクスポート処理は実行されていない
- **テストの目的**: コンポーネントの基本的なレンダリングを確認
  - **確認ポイント**: Buttonコンポーネントが正しくインポートされ使用されている
- **🔵 信頼性レベル**: 青信号（要件定義書のUI構成に基づく）
- **参照要件**: REQ-301（画像保存ボタンを提供）

#### テストケース 1-2: ボタンクリックでexportAsImageが呼ばれる

- **テスト名**: ボタンクリックでexportAsImageが呼ばれる
  - **何をテストするか**: ボタンクリック時にuseImageExportフックのexportAsImage関数が正しい引数で呼び出される
  - **期待される動作**: クリックイベント → handleClick → exportAsImage(element, filename)
- **入力値**:
  ```typescript
  <ImageSaveButton
    targetSelector=".display-container"
    filename="my-gift"
  />
  ```
  - **入力データの意味**: 実際の使用シーンを想定したProps
- **期待される結果**:
  - exportAsImageが1回呼ばれる
  - 第1引数: document.querySelector('.display-container')の戻り値
  - 第2引数: 'my-gift'
  - **期待結果の理由**: REQ-302（ボタンクリックで画像化）の要件を満たす
- **テストの目的**: ボタンクリックイベントハンドラーが正しく機能することを確認
  - **確認ポイント**:
    - targetSelectorで正しく要素を取得している
    - filename propsがexportAsImageに渡されている
- **🔵 信頼性レベル**: 青信号（タスクファイルの実装詳細に基づく）
- **参照要件**: REQ-302（ボタンクリックで表示ページを画像化）

#### テストケース 1-3: ファイル名省略時はformatFilenameが使用される

- **テスト名**: ファイル名が指定されない場合はexportAsImageにundefinedが渡される
  - **何をテストするか**: filename propsを省略した場合、exportAsImageにundefinedが渡される
  - **期待される動作**: exportAsImageフック内部でformatFilename()が呼ばれる（フック側でテスト済み）
- **入力値**:
  ```typescript
  <ImageSaveButton targetSelector=".container" />
  ```
  - **入力データの意味**: filename省略時のデフォルト動作を確認
- **期待される結果**:
  - exportAsImageが1回呼ばれる
  - 第2引数がundefined
  - **期待結果の理由**: オプショナルなpropsの動作を保証
- **テストの目的**: デフォルト動作の確認（REQ-306対応はuseImageExportフック側）
  - **確認ポイント**: filenameを省略してもエラーにならない
- **🔵 信頼性レベル**: 青信号（要件定義書のProps仕様に基づく）
- **参照要件**: REQ-306（ファイル名に日付を含める - useImageExportで処理）

### 2. 異常系テストケース（エラーハンドリング）

#### テストケース 2-1: 対象要素が存在しない場合はエラーログが出る

- **テスト名**: 対象要素が存在しない場合はエラーログが出る
  - **エラーケースの概要**: document.querySelector()がnullを返す場合
  - **エラー処理の重要性**: セレクタの入力ミスやDOM構造変更時のデバッグ支援
- **入力値**:
  ```typescript
  <ImageSaveButton targetSelector=".non-existent-element" />
  ```
  - **不正な理由**: 存在しないCSSセレクタを指定
  - **実際の発生シナリオ**: 開発時のセレクタ記述ミス、DOM構造変更時
- **期待される結果**:
  - console.errorが呼ばれる
  - エラーメッセージ: `"Element not found: .non-existent-element"`
  - exportAsImageは呼ばれない
  - ボタンは無効化されない（次回のクリックは可能）
  - **エラーメッセージの内容**: 開発者が問題を特定しやすいよう、セレクタを含める
  - **システムの安全性**: エラーログのみで処理を中断し、ユーザーには影響しない
- **テストの目的**: 要素未検出時の適切なエラーハンドリングを確認
  - **品質保証の観点**: サイレントエラーを防ぎ、開発時のデバッグ性を向上
- **🟡 信頼性レベル**: 黄信号（要件定義書に記載あり、実装詳細は推測）
- **参照要件**: EDGE-001（要素が見つからない場合のエラー処理）

#### テストケース 2-2: exportAsImage実行中のエラーはフック側で処理

- **テスト名**: exportAsImage実行中のエラーはuseImageExportフックで処理される
  - **エラーケースの概要**: 画像生成処理中のエラー（html2canvas失敗等）
  - **エラー処理の重要性**: ユーザーにエラー原因を適切に通知し、UXを保つ
- **入力値**: 通常のProps
- **期待される動作**:
  - exportAsImageがエラーをthrowした場合、フック内部でcatch
  - Toast通知でユーザーに通知（フック側でテスト済み）
  - ImageSaveButtonコンポーネントは何もしない
  - **エラー処理の理由**: 責務分離（エラーハンドリングはフック側）
- **テストの目的**: エラー処理の責務がフック側にあることを確認
  - **品質保証の観点**: 適切な責務分離により保守性向上
- **🔵 信頼性レベル**: 青信号（タスクファイルの実装詳細、TASK-0038仕様に基づく）
- **参照要件**: REQ-311（画像生成失敗時にエラー通知 - useImageExportで処理）

### 3. 状態管理テストケース（UI状態の変化）

#### テストケース 3-1: エクスポート中はボタンが無効化される

- **テスト名**: エクスポート中はボタンが無効化される
  - **何をテストするか**: isExporting=trueの時、ボタンがdisabled状態になる
  - **期待される動作**: 連続クリックを防止し、処理の重複実行を回避
- **入力値**: useImageExportフックをモックし、isExporting=trueを返す
  - **状態設定の意味**: エクスポート処理中の状態をシミュレート
- **期待される結果**:
  - ボタンが `disabled` 属性を持つ
  - ボタンがクリック不可能
  - **期待結果の理由**: EDGE-002（エクスポート中の連続クリック防止）
- **テストの目的**: ボタンの無効化制御が正しく機能することを確認
  - **確認ポイント**: `disabled={isExporting}` の実装が正しい
- **🔵 信頼性レベル**: 青信号（タスクファイルの実装詳細に基づく）
- **参照要件**: EDGE-002（エクスポート中の連続クリック防止）

#### テストケース 3-2: エクスポート中はローディング表示される

- **テスト名**: エクスポート中はローディング表示される
  - **何をテストするか**: isExporting=trueの時、ローディングスピナーが表示される
  - **期待される動作**: 処理中であることをユーザーに視覚的にフィードバック
- **入力値**: useImageExportフックをモックし、isExporting=trueを返す
  - **状態設定の意味**: エクスポート処理中の状態をシミュレート
- **期待される結果**:
  - ローディングコンテナ (`role="status"`) が存在する
  - `aria-live="polite"` 属性が設定されている
  - スクリーンリーダー用テキスト「画像を生成しています...」が存在
  - スピナー要素が存在
  - **期待結果の理由**: ユーザーに処理中であることを明確に伝える
- **テストの目的**: ローディング表示の条件分岐とアクセシビリティ対応を確認
  - **確認ポイント**:
    - `{isExporting && <div>...</div>}` の条件レンダリング
    - アクセシビリティ属性（role, aria-live）
- **🔵 信頼性レベル**: 青信号（タスクファイルの実装詳細、アクセシビリティ要件に基づく）
- **参照要件**: NFR-205（アクセシビリティ）、REQ-301（UI提供）

#### テストケース 3-3: エクスポート中はボタンテキストが「保存中...」になる

- **テスト名**: エクスポート中はボタンテキストが「保存中...」になる
  - **何をテストするか**: isExporting=trueの時、ボタンテキストが変化する
  - **期待される動作**: 処理状態をボタンテキストでも伝える
- **入力値**: useImageExportフックをモックし、isExporting=trueを返す
- **期待される結果**:
  - ボタンテキストが「保存中...」
  - **期待結果の理由**: 多様なフィードバック手段でUX向上
- **テストの目的**: ボタンテキストの動的変更を確認
  - **確認ポイント**: `{isExporting ? '保存中...' : '画像として保存'}`
- **🔵 信頼性レベル**: 青信号（タスクファイルの実装詳細に基づく）
- **参照要件**: REQ-301（UI提供）

### 4. アクセシビリティテストケース

#### テストケース 4-1: ARIAラベルが正しく設定される

- **テスト名**: ARIAラベルが正しく設定される
  - **何をテストするか**: ボタンにaria-label属性が適切に設定されている
  - **期待される動作**: スクリーンリーダーユーザーがボタンの目的を理解できる
- **入力値**: 通常のProps
- **期待される結果**:
  - ボタンに `aria-label="画像として保存"` 属性が存在
  - **期待結果の理由**: NFR-205（アクセシビリティ要件）を満たす
- **テストの目的**: アクセシビリティ対応の確認
  - **確認ポイント**: ARIA属性の存在と内容
- **🔵 信頼性レベル**: 青信号（タスクファイル、アクセシビリティ要件に基づく）
- **参照要件**: NFR-205（キーボードで操作可能、スクリーンリーダー対応）

#### テストケース 4-2: ローディング時のaria-live設定を確認

- **テスト名**: ローディング表示にaria-live="polite"が設定される
  - **何をテストするか**: ローディングコンテナにaria-live属性が設定されている
  - **期待される動作**: スクリーンリーダーがローディング状態を読み上げる
- **入力値**: isExporting=trueの状態
- **期待される結果**:
  - ローディングコンテナに `aria-live="polite"` 属性
  - `role="status"` 属性
  - スクリーンリーダー専用テキスト（.sr-only）が存在
  - **期待結果の理由**: 視覚障害者も処理状態を把握できる
- **テストの目的**: 動的コンテンツのアクセシビリティ確認
  - **確認ポイント**: aria-live, role属性、スクリーンリーダー専用テキスト
- **🔵 信頼性レベル**: 青信号（タスクファイル、アクセシビリティ要件に基づく）
- **参照要件**: NFR-205（アクセシビリティ）

### 5. Props検証テストケース

#### テストケース 5-1: targetSelector propsが正しくdocument.querySelectorに渡される

- **テスト名**: targetSelector propsがdocument.querySelectorに渡される
  - **何をテストするか**: 渡されたtargetSelectorでDOM要素を検索している
  - **期待される動作**: セレクタ文字列がそのまま使用される
- **入力値**:
  ```typescript
  <ImageSaveButton targetSelector="#test-id" filename="test" />
  ```
  - **入力データの意味**: IDセレクタを使用した例
- **期待される結果**:
  - document.querySelector('#test-id')が呼ばれる
  - 取得した要素がexportAsImageに渡される
  - **期待結果の理由**: Props → DOM API → フック の正しいデータフロー
- **テストの目的**: Props値の正しい伝播を確認
  - **確認ポイント**: セレクタ文字列の変換や加工が行われていない
- **🔵 信頼性レベル**: 青信号（タスクファイルの実装詳細に基づく）
- **参照要件**: REQ-302（表示ページを画像化）

#### テストケース 5-2: filename propsがexportAsImageに渡される

- **テスト名**: filename propsがexportAsImageの第2引数に渡される
  - **何をテストするか**: filename propsの値がそのまま渡される
  - **期待される動作**: Props値を変更せずに伝播
- **入力値**:
  ```typescript
  <ImageSaveButton targetSelector=".test" filename="custom-name" />
  ```
- **期待される結果**:
  - exportAsImage(element, 'custom-name')が呼ばれる
  - **期待結果の理由**: Props → フック の正しいデータフロー
- **テストの目的**: オプショナルなPropsの伝播確認
  - **確認ポイント**: filenameがそのまま渡される
- **🔵 信頼性レベル**: 青信号（タスクファイルの実装詳細に基づく）
- **参照要件**: REQ-306（ファイル名に日付を含める - フック側で処理）

### 6. 統合テストケース

#### テストケース 6-1: Buttonコンポーネントが正しく使用されている

- **テスト名**: 共通Buttonコンポーネントが正しく使用されている
  - **何をテストするか**: 既存のButtonコンポーネントを再利用している
  - **期待される動作**: 統一感のあるUIデザイン
- **入力値**: 通常のProps
- **期待される結果**:
  - Buttonコンポーネントがレンダリングされる
  - `variant="primary"` が設定されている
  - **期待結果の理由**: UIデザインの統一性（要件定義書の制約条件）
- **テストの目的**: 既存コンポーネントの再利用を確認
  - **確認ポイント**: Buttonコンポーネントのインポートと使用
- **🔵 信頼性レベル**: 青信号（要件定義書の設計制約に基づく）
- **参照要件**: UIデザイン制約（既存Buttonコンポーネント使用）

## テストケース実装時の日本語コメント例

### テストケース開始時

```typescript
describe('ImageSaveButton - TASK-0039', () => {
  // 【テスト目的】: 画像保存ボタンコンポーネントの全機能を検証
  // 【テスト内容】: レンダリング、クリックイベント、状態管理、アクセシビリティ
  // 【期待される動作】: 全要件を満たし、エラーハンドリングが適切
  // 🔵 タスクファイルおよび要件定義書に基づく

  it('正しくレンダリングされる', () => {
    // 【テスト目的】: コンポーネントの基本的なレンダリングを確認 🔵
    // 【テスト内容】: 初期状態でボタンが正しく表示されることを検証
    // 【期待される動作】: ボタンが存在し、初期テキストが「画像として保存」

    // 【テストデータ準備】: 基本的なPropsを設定
    const props = {
      targetSelector: '.test-container',
      filename: 'test-image'
    };

    // 【実際の処理実行】: コンポーネントをレンダリング
    render(<ImageSaveButton {...props} />);

    // 【結果検証】: ボタンが存在することを確認 🔵
    expect(screen.getByRole('button')).toBeInTheDocument();
    // 【確認内容】: 初期テキストが「画像として保存」であることを確認 🔵
    expect(screen.getByText('画像として保存')).toBeInTheDocument();
  });
});
```

### Given-When-Then形式の例

```typescript
it('ボタンクリックでexportAsImageが呼ばれる', async () => {
  // 【テスト目的】: クリックイベントハンドラーが正しく機能することを確認 🔵

  // === Given（準備フェーズ）===
  // 【テストデータ準備】: useImageExportフックをモック化
  // 【初期条件設定】: DOM要素とexportAsImageモックを準備
  const mockExportAsImage = vi.fn().mockResolvedValue(true);
  const mockElement = document.createElement('div');
  document.querySelector = vi.fn().mockReturnValue(mockElement);

  vi.mock('../../hooks/useImageExport', () => ({
    useImageExport: () => ({
      isExporting: false,
      exportAsImage: mockExportAsImage,
    }),
  }));

  // === When（実行フェーズ）===
  // 【実際の処理実行】: コンポーネントをレンダリングしてボタンをクリック
  render(<ImageSaveButton targetSelector=".display-container" filename="my-gift" />);
  await userEvent.click(screen.getByRole('button'));

  // === Then（検証フェーズ）===
  // 【結果検証】: exportAsImageが正しい引数で呼ばれたことを確認
  // 【期待値確認】: 第1引数はDOM要素、第2引数はfilename 🔵
  expect(mockExportAsImage).toHaveBeenCalledWith(mockElement, 'my-gift');
  // 【品質保証】: クリックイベントが正しくフック関数を呼び出すことを保証
  expect(mockExportAsImage).toHaveBeenCalledTimes(1);
});
```

## テストカバレッジ目標

- **ステートメントカバレッジ**: 90%以上
- **ブランチカバレッジ**: 85%以上
- **関数カバレッジ**: 100%
- **ラインカバレッジ**: 90%以上

## テストケース分類サマリー

- **正常系**: 3テストケース（基本レンダリング、クリック、ファイル名省略）
- **異常系**: 2テストケース（要素未検出、エラー処理責務）
- **状態管理**: 3テストケース（ボタン無効化、ローディング表示、テキスト変更）
- **アクセシビリティ**: 2テストケース（ARIAラベル、aria-live）
- **Props検証**: 2テストケース（targetSelector、filename）
- **統合テスト**: 1テストケース（Buttonコンポーネント使用）

**合計**: 13テストケース

## 品質判定

### 判定結果: ✅ 高品質

**評価**:
- ✅ テストケース分類: 正常系・異常系・状態管理・アクセシビリティ・Props検証が網羅
- ✅ 期待値定義: 各テストケースの期待値が明確（Given-When-Then形式）
- ✅ 技術選択: TypeScript + Vitest + React Testing Library（プロジェクト標準）
- ✅ 実装可能性: 既存テストパターンに準拠し、実装可能

**信頼性レベル分布**:
- 🔵 高信頼: 85% (タスクファイル、要件定義書、既存テストパターンに基づく)
- 🟡 中信頼: 15% (妥当な推測、エラーハンドリング詳細)
- 🔴 低信頼: 0%

**要件網羅性**:
- REQ-301: 画像保存ボタンを提供 ✅
- REQ-302: ボタンクリックで画像化 ✅
- REQ-306: ファイル名に日付を含める ✅（間接的）
- NFR-205: キーボードで操作可能 ✅
- EDGE-001: 要素が見つからない場合のエラー処理 ✅
- EDGE-002: エクスポート中の連続クリック防止 ✅

---

**作成日**: 2025-11-22
**作成者**: Claude Code (TDD Testcases Phase)

**次のお勧めステップ**: `/tsumiki:tdd-red` でRedフェーズ（失敗テスト作成）を開始します。

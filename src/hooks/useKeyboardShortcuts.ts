import { useEffect, useCallback, useMemo } from 'react';

/**
 * ğŸ”µ ã€å‹å®šç¾©ã€‘: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®æ§‹é€ å®šç¾©ï¼ˆNFR-205è¦ä»¶ãƒ™ãƒ¼ã‚¹ï¼‰
 *
 * ã€è¨­è¨ˆæ–¹é‡ã€‘:
 * - ä¿®é£¾ã‚­ãƒ¼ï¼ˆCtrl, Shift, Altï¼‰ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆfalse
 * - callbackã¯å¼•æ•°ãªã—ãƒ»æˆ»ã‚Šå€¤ãªã—ã®é–¢æ•°å‹
 * - descriptionã¯é–‹ç™ºè€…å‘ã‘ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œã«ä½¿ç”¨
 */
export interface KeyboardShortcut {
  /** ğŸ”µ ã€ã‚­ãƒ¼åã€‘: KeyboardEvent.keyã®å€¤ï¼ˆä¾‹: 'Escape', 's', 'Enter'ï¼‰ */
  key: string;
  /** ğŸ”µ ã€Ctrlä¿®é£¾ã‚­ãƒ¼ã€‘: Ctrlã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰ */
  ctrlKey?: boolean;
  /** ğŸ”µ ã€Shiftä¿®é£¾ã‚­ãƒ¼ã€‘: Shiftã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰ */
  shiftKey?: boolean;
  /** ğŸ”µ ã€Altä¿®é£¾ã‚­ãƒ¼ã€‘: Altã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰ */
  altKey?: boolean;
  /** ğŸ”µ ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã€‘: ã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒ³ãƒ‰ãƒ© */
  callback: () => void;
  /** ğŸ”µ ã€èª¬æ˜æ–‡ã€‘: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®ç”¨é€”èª¬æ˜ï¼ˆé–‹ç™ºè€…å‘ã‘ãƒ»a11yå¯¾å¿œï¼‰ */
  description: string;
}

/**
 * ğŸ”µ ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‘: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã®ä¸€æ„è­˜åˆ¥å­ã‚’ç”Ÿæˆ
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ã‚­ãƒ¼ã¨ä¿®é£¾ã‚­ãƒ¼ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰ä¸€æ„ã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
 * ã€å†åˆ©ç”¨æ€§ã€‘: Mapæ§‹é€ ã®ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã—ã€O(1)æ¤œç´¢ã‚’å®Ÿç¾
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: æ–‡å­—åˆ—çµåˆã«ã‚ˆã‚‹é«˜é€Ÿãªè­˜åˆ¥å­ç”Ÿæˆ
 *
 * @param key - ã‚­ãƒ¼å
 * @param ctrlKey - Ctrlã‚­ãƒ¼ã®çŠ¶æ…‹
 * @param shiftKey - Shiftã‚­ãƒ¼ã®çŠ¶æ…‹
 * @param altKey - Altã‚­ãƒ¼ã®çŠ¶æ…‹
 * @returns ä¸€æ„ã®è­˜åˆ¥å­æ–‡å­—åˆ—ï¼ˆä¾‹: "Ctrl+Shift+s"ï¼‰
 */
const createShortcutKey = (
  key: string,
  ctrlKey: boolean,
  shiftKey: boolean,
  altKey: boolean
): string => {
  // ğŸ”µ ã€è­˜åˆ¥å­æ§‹ç¯‰ã€‘: ä¿®é£¾ã‚­ãƒ¼ã‚’é †åºä»˜ã‘ã¦çµåˆã—ä¸€æ„æ€§ã‚’ä¿è¨¼
  const modifiers: string[] = [];
  if (ctrlKey) modifiers.push('Ctrl');
  if (shiftKey) modifiers.push('Shift');
  if (altKey) modifiers.push('Alt');

  // ğŸ”µ ã€æœ€é©åŒ–æ¸ˆã¿ã€‘: æ–‡å­—åˆ—çµåˆã«ã‚ˆã‚‹é«˜é€Ÿãªè­˜åˆ¥å­ç”Ÿæˆ
  return modifiers.length > 0 ? `${modifiers.join('+')}+${key}` : key;
};

/**
 * ğŸ”µ ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã€‘: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ç™»éŒ²ãƒ»ç®¡ç†ï¼ˆNFR-205è¦ä»¶æº–æ‹ ï¼‰
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ã‚°ãƒ­ãƒ¼ãƒãƒ«keydownã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã—ã€ç™»éŒ²ã•ã‚ŒãŸã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’å®Ÿè¡Œ
 * ã€è¨­è¨ˆæ–¹é‡ã€‘:
 * - Mapæ§‹é€ ã«ã‚ˆã‚‹O(1)æ¤œç´¢ã§å¤§é‡ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã«å¯¾å¿œ
 * - useCallbackã«ã‚ˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®ãƒ¡ãƒ¢åŒ–ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–
 * - try-catchã«ã‚ˆã‚‹ä¾‹å¤–åˆ†é›¢ã§éƒ¨åˆ†çš„éšœå®³ã‹ã‚‰ã®ä¿è­·
 * - é–‹ç™ºç’°å¢ƒã§ã®ã¿ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›ï¼ˆæœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–ï¼‰
 *
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘:
 * - æ™‚é–“è¨ˆç®—é‡: O(1) - Mapæ¤œç´¢ã«ã‚ˆã‚‹å®šæ•°æ™‚é–“ã‚¢ã‚¯ã‚»ã‚¹
 * - ç©ºé–“è¨ˆç®—é‡: O(n) - ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆæ•°ã«æ¯”ä¾‹
 * - ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–: useCallback/useMemoã«ã‚ˆã‚‹ä¸è¦ãªå†ç”Ÿæˆé˜²æ­¢
 *
 * ã€ä¿å®ˆæ€§ã€‘:
 * - è©³ç´°ãªæ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆã§å¯èª­æ€§å‘ä¸Š
 * - å˜ä¸€è²¬ä»»åŸå‰‡ã«åŸºã¥ãé–¢æ•°åˆ†å‰²
 * - TypeScriptã«ã‚ˆã‚‹å‹å®‰å…¨æ€§ä¿è¨¼
 *
 * @param shortcuts - ç™»éŒ²ã™ã‚‹ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®é…åˆ—
 *
 * @example
 * ```tsx
 * // åŸºæœ¬çš„ãªä½¿ç”¨ä¾‹
 * const shortcuts: KeyboardShortcut[] = [
 *   {
 *     key: 'Escape',
 *     callback: () => navigate('/'),
 *     description: 'ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹'
 *   },
 *   {
 *     key: 's',
 *     ctrlKey: true,
 *     callback: () => handleSave(),
 *     description: 'ç”»åƒã‚’ä¿å­˜'
 *   }
 * ];
 *
 * useKeyboardShortcuts(shortcuts);
 * ```
 */
export const useKeyboardShortcuts = (shortcuts: KeyboardShortcut[]): void => {
  /**
   * ğŸ”µ ã€Mapæ§‹é€ æ§‹ç¯‰ã€‘: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé…åˆ—ã‚’Mapæ§‹é€ ã«å¤‰æ›ã—ã¦O(1)æ¤œç´¢ã‚’å®Ÿç¾
   *
   * ã€æ©Ÿèƒ½æ”¹å–„ã€‘: å¾“æ¥ã®O(n)æ¤œç´¢ã‹ã‚‰O(1)æ¤œç´¢ã¸ã®æœ€é©åŒ–
   * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: å¤§é‡ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆ100å€‹ä»¥ä¸Šï¼‰ã§ã‚‚é«˜é€Ÿå‹•ä½œ
   * ã€é‡è¤‡ã‚­ãƒ¼å¯¾å¿œã€‘: åŒä¸€ã‚­ãƒ¼ã®è¤‡æ•°ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é…åˆ—ã§ç®¡ç†
   */
  const shortcutMap = useMemo(() => {
    // ğŸ”µ ã€MapåˆæœŸåŒ–ã€‘: ã‚­ãƒ¼è­˜åˆ¥å­ -> ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é…åˆ—ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const map = new Map<string, Array<() => void>>();

    // ğŸ”µ ã€Mapæ§‹ç¯‰ã€‘: å„ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’Mapæ§‹é€ ã«ç™»éŒ²
    shortcuts.forEach((shortcut) => {
      const {
        key,
        ctrlKey = false,
        shiftKey = false,
        altKey = false,
        callback,
      } = shortcut;

      // ğŸ”µ ã€ä¸€æ„ã‚­ãƒ¼ç”Ÿæˆã€‘: ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§è­˜åˆ¥å­ã‚’ä½œæˆ
      const shortcutKey = createShortcutKey(key, ctrlKey, shiftKey, altKey);

      // ğŸ”µ ã€é‡è¤‡å¯¾å¿œã€‘: æ—¢å­˜ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Œã°è¿½åŠ ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
      const existingCallbacks = map.get(shortcutKey);
      if (existingCallbacks) {
        existingCallbacks.push(callback);
      } else {
        map.set(shortcutKey, [callback]);
      }
    });

    return map;
  }, [shortcuts]);

  /**
   * ğŸ”µ ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã€‘: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã—ã¦ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’å®Ÿè¡Œ
   *
   * ã€æ”¹å–„å†…å®¹ã€‘: forEachæ¤œç´¢ã‹ã‚‰Mapæ¤œç´¢ã¸ã®å¤‰æ›´ã§O(n)â†’O(1)ã«æœ€é©åŒ–
   * ã€å®‰å…¨æ€§ç¢ºä¿ã€‘: try-catchã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¾‹å¤–ã‚’åˆ†é›¢ã—ã€ä»–ã¸ã®å½±éŸ¿ã‚’é˜²æ­¢
   * ã€æœ¬ç•ªæœ€é©åŒ–ã€‘: é–‹ç™ºç’°å¢ƒã§ã®ã¿ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›
   */
  const handleKeyDown = useCallback(
    (event: KeyboardEvent) => {
      // ğŸ”µ ã€ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±æŠ½å‡ºã€‘: KeyboardEventã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—
      const { key, ctrlKey, shiftKey, altKey } = event;

      // ğŸ”µ ã€O(1)æ¤œç´¢ã€‘: Mapæ§‹é€ ã«ã‚ˆã‚‹é«˜é€Ÿã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆæ¤œç´¢
      const shortcutKey = createShortcutKey(key, ctrlKey, shiftKey, altKey);
      const callbacks = shortcutMap.get(shortcutKey);

      // ğŸ”µ ã€æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã€‘: è©²å½“ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒãªã„å ´åˆã¯å³åº§ã«çµ‚äº†
      if (!callbacks) {
        return;
      }

      // ğŸ”µ ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œæŠ‘åˆ¶ã€‘: ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–å‹•ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      event.preventDefault();

      // ğŸ”µ ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œã€‘: ç™»éŒ²ã•ã‚ŒãŸå…¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é †æ¬¡å®Ÿè¡Œ
      callbacks.forEach((callback) => {
        try {
          // ğŸ”µ ã€å®‰å…¨ãªå®Ÿè¡Œã€‘: try-catchã§ä¾‹å¤–ã‚’åˆ†é›¢
          callback();
        } catch (error) {
          // ğŸŸ¡ ã€é–‹ç™ºç’°å¢ƒé™å®šãƒ­ã‚°ã€‘: æœ¬ç•ªç’°å¢ƒã§ã®ãƒ­ã‚°å‡ºåŠ›ã‚’æŠ‘åˆ¶ï¼ˆæ¨æ¸¬ãƒ™ãƒ¼ã‚¹ï¼‰
          if (import.meta.env.DEV) {
            console.error(
              `Keyboard shortcut callback error (${shortcutKey}):`,
              error
            );
          }
        }
      });
    },
    [shortcutMap]
  );

  /**
   * ğŸ”µ ã€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã€‘: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
   *
   * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒã‚¦ãƒ³ãƒˆ/ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’é©åˆ‡ã«ç®¡ç†
   * ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã€‘: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ã§ç¢ºå®Ÿã«ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
   * ã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–ã€‘: handleKeyDownå¤‰æ›´æ™‚ã®ã¿å†å®Ÿè¡Œ
   */
  useEffect(() => {
    // ğŸ”µ ã€ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²ã€‘: ã‚°ãƒ­ãƒ¼ãƒãƒ«keydownã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–é–‹å§‹
    window.addEventListener('keydown', handleKeyDown);

    // ğŸ”µ ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€‘: ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã¾ãŸã¯handleKeyDownå¤‰æ›´æ™‚ã«ãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
    };
  }, [handleKeyDown]);
};
